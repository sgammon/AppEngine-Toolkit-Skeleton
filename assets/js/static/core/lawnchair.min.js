var Lawnchair=function(){if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0){var a=typeof arguments[0]=="function"?arguments[0]:arguments[1],b=typeof arguments[0]=="function"?{}:arguments[0];if(typeof a!="function")throw"No callback was provided";var c=this instanceof Lawnchair?this:new Lawnchair(b,a);c.record=b.record||"record",c.name=b.name||"records";var d;if(b.adapter)d=Lawnchair.adapters[c.indexOf(Lawnchair.adapters,b.adapter)],d=d.valid()?d:undefined;else for(var e=0,f=Lawnchair.adapters.length;e<f;e++){d=Lawnchair.adapters[e].valid()?Lawnchair.adapters[e]:undefined;if(d)break}if(!d)throw"No valid adapter.";for(var g in d)c[g]=d[g];for(var e=0,f=Lawnchair.plugins.length;e<f;e++)Lawnchair.plugins[e].call(c);return c.init(b,a),c}throw"Incorrect # of ctor args!"};Lawnchair.adapters=[],Lawnchair.adapter=function(a,b){b.adapter=a;var c="adapter valid init keys save batch get exists all remove nuke".split(" "),d=this.prototype.indexOf;for(var e in b)if(d(c,e)===-1)throw"Invalid adapter! Nonstandard method: "+e;return Lawnchair.adapters.push(b),b},Lawnchair.plugins=[],Lawnchair.plugin=function(a){for(var b in a)b==="init"?Lawnchair.plugins.push(a[b]):this.prototype[b]=a[b]},Lawnchair.prototype={isArray:Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},indexOf:function(a,b,c,d){if(a.indexOf)return a.indexOf(b);for(c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},lambda:function(a){return this.fn(this.record,a)},fn:function(a,b){return typeof b=="string"?new Function(a,b):b},uuid:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},each:function(a){var b=this.lambda(a);if(this.__results)for(var c=0,d=this.__results.length;c<d;c++)b.call(this,this.__results[c],c);else this.all(function(a){for(var c=0,d=a.length;c<d;c++)b.call(this,a[c],c)});return this}},window.LawnchairDOM=Lawnchair.adapter("dom",{valid:function(){return!!window.Storage},init:function(a,b){this.storage=window.localStorage;var c=this;this.indexer={key:c.name+"._index_",all:function(){var a=JSON.parse(c.storage.getItem(this.key));return a==null&&c.storage.setItem(this.key,JSON.stringify([])),JSON.parse(c.storage.getItem(this.key))},add:function(a){var b=this.all();b.push(a),c.storage.setItem(this.key,JSON.stringify(b))},del:function(a){var b=this.all(),d=[];for(var e=0,f=b.length;e<f;e++)b[e]!=a&&d.push(b[e]);c.storage.setItem(this.key,JSON.stringify(d))},find:function(a){var b=this.all();for(var c=0,d=b.length;c<d;c++)if(a===b[c])return c;return!1}},b&&this.fn(this.name,b).call(this,this)},save:function(a,b){var c=a.key||this.uuid();return this.indexer.find(c)||this.indexer.add(c),delete a.key,this.storage.setItem(c,JSON.stringify(a)),b&&(a.key=c,this.lambda(b).call(this,a)),this},batch:function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++)this.save(a[d],function(a){c.push(a)});return b&&this.lambda(b).call(this,c),this},keys:function(){var a=options.limit||null,b=options.offset||0;callback&&this.lambda(callback).call(this,this.indexer.all())},get:function(a,b){if(this.isArray(a)){var c=[];for(var d=0,e=a.length;d<e;d++){var f=JSON.parse(this.storage.getItem(a[d]));f&&(f.key=a[d],c.push(f))}b&&this.lambda(b).call(this,c)}else{var f=JSON.parse(this.storage.getItem(a));f&&(f.key=a),b&&this.lambda(b).call(this,f)}return this},all:function(a){var b=this.indexer.all(),c=[],d;for(var e=0,f=b.length;e<f;e++)d=JSON.parse(this.storage.getItem(b[e])),d.key=b[e],c.push(d);return a&&this.fn(this.name,a).call(this,c),this},remove:function(a,b){var c=typeof a=="string"?a:a.key;return this.indexer.del(c),this.storage.removeItem(c),b&&this.lambda(b).call(this),this},nuke:function(a){return this.all(function(b){for(var c=0,d=b.length;c<d;c++)this.remove(b[c]);a&&this.lambda(a).call(this)}),this}}),window.LawnchairWindowName=Lawnchair.adapter("window-name",function(a,b){var c=window.top.name?JSON.parse(window.top.name):{};return{valid:function(){return typeof window.top.name!="undefined"},init:function(d,e){c[this.name]={index:[],store:{}},a=c[this.name].index,b=c[this.name].store,this.fn(this.name,e).call(this,this)},keys:function(b){return this.fn("keys",b).call(this,a),this},save:function(d,e){var f=d.key||this.uuid();return d.key&&delete d.key,this.exists(f,function(g){g||a.push(f),b[f]=d,window.top.name=JSON.stringify(c),e&&(d.key=f,this.lambda(e).call(this,d))}),this},batch:function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++)this.save(a[d],function(a){c.push(a)});return b&&this.lambda(b).call(this,c),this},get:function(a,c){var d;if(this.isArray(a)){d=[];for(var e=0,f=a.length;e<f;e++)d.push(b[a[e]])}else d=b[a],d&&(d.key=a);return c&&this.lambda(c).call(this,d),this},exists:function(a,c){return this.lambda(c).call(this,!!b[a]),this},all:function(c){var d=[];for(var e=0,f=a.length;e<f;e++){var g=b[a[e]];g.key=a[e],d.push(g)}return this.fn(this.name,c).call(this,d),this},remove:function(d,e){var f=this.isArray(d)?d:[d];for(var g=0,h=f.length;g<h;g++)delete b[f[g]],a.splice(this.indexOf(a,f[g]),1);return window.top.name=JSON.stringify(c),e&&this.lambda(e).call(this),this},nuke:function(b){return storage={},a=[],window.top.name=JSON.stringify(c),b&&this.lambda(b).call(this),this}}}()),window.LawnchairIndexedDB=Lawnchair.adapter("indexed-db",function(){function a(a,b){console.log("error in indexed-db adapter!",a,b);debugger}function b(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB}return{valid:function(){return!!b()},init:function(c,d){this.idb=b(),this.waiting=[];var e=this.idb.open(this.name),f=this,g=f.fn(f.name,d),h=function(){return g.call(f,f)};e.onsuccess=function(b){f.db=e.result;if(f.db.version!="1.0"){var c=f.db.setVersion("1.0");c.onsuccess=function(a){f.store=f.db.createObjectStore("teststore",{autoIncrement:!0});for(var b=0;b<f.waiting.length;b++)f.waiting[b].call(f);f.waiting=[],h()},c.onerror=function(b){console.log("Failed to create objectstore "+b),a(b)}}else{f.store={};for(var d=0;d<f.waiting.length;d++)f.waiting[d].call(f);f.waiting=[],h()}},e.onerror=a},save:function(b,c){if(!this.store){this.waiting.push(function(){this.save(b,c)});return}var d=this,e=function(a){c&&(b.key=a.target.result,d.lambda(c).call(d,b))},f=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE,0),g=f.objectStore("teststore"),h=b.key?g.put(b,b.key):g.put(b);return h.onsuccess=e,h.onerror=a,this},batch:function(a,b){var c=[],d=!1,e=this,f=function(b){c.push(b),d=c.length===a.length},g=setInterval(function(){d&&(b&&e.lambda(b).call(e,c),clearInterval(g))},200);for(var h=0,i=a.length;h<i;h++)this.save(a[h],f);return this},get:function(b,c){if(!this.store){this.waiting.push(function(){this.get(b,c)});return}var d=this,e=function(a){c&&d.lambda(c).call(d,a.target.result)};if(!this.isArray(b)){var f=this.db.transaction("teststore").objectStore("teststore").get(b);f.onsuccess=e,f.onerror=function(c){console.log("Failed to find "+b),a(c)}}else{var g=[],h=!1,i=b,j=function(a){g.push(a),h=g.length===i.length},k=setInterval(function(){h&&(c&&d.lambda(c).call(d,g),clearInterval(k))},200);for(var l=0,m=i.length;l<m;l++)this.get(i[l],j)}return this},all:function(a){if(!this.store){this.waiting.push(function(){this.all(a)});return}var b=this.fn(this.name,a)||undefined,c=this,d=this.db.transaction("teststore").objectStore("teststore"),e=[];return d.openCursor().onsuccess=function(a){var d=a.target.result;d?(e.push(d.value),d.continue()):b&&b.call(c,e)},this},remove:function(b,c){if(!this.store){this.waiting.push(function(){this.remove(b,c)});return}typeof b=="object"&&(b=b.key);var d=this,e=function(){c&&d.lambda(c).call(d)},f=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").delete(b);return f.onsuccess=e,f.onerror=a,this},nuke:function(b){if(!this.store){this.waiting.push(function(){this.nuke(b)});return}var c=this,d=b?function(){c.lambda(b).call(c)}:function(){};try{this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").clear().onsuccess=d}catch(e){a()}return this}}}()),window.LawnchairWebkitSQLite=Lawnchair.adapter("webkit-sqlite",function(){var a=function(a,b){console.log("error in sqlite adaptor!",a,b)},b=function(){return new Date};return Function.prototype.bind||(Function.prototype.bind=function(a){var b=[].slice,c=b.call(arguments,1),d=this,e=function(){},f=function(){return d.apply(this instanceof e?this:a||{},c.concat(b.call(arguments)))};return e.prototype=d.prototype,f.prototype=new e,f}),{valid:function(){return!!window.openDatabase},init:function(b,c){var d=this,e=d.fn(d.name,c),f="CREATE TABLE IF NOT EXISTS "+this.name+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",g=function(){return e.call(d,d)};this.db=openDatabase(this.name,"1.0.0",this.name,65536),this.db.transaction(function(b){b.executeSql(f,[],g,a)})},keys:function(b){var c=this.lambda(b),d=this,e="SELECT id FROM "+this.name+" ORDER BY timestamp DESC";return this.db.transaction(function(b){var f=function(a,b){if(b.rows.length==0)c.call(d,[]);else{var e=[];for(var f=0,g=b.rows.length;f<g;f++)e.push(b.rows.item(f).id);c.call(d,e)}};b.executeSql(e,[],f,a)}),this},save:function(c,d){var e=this,f=c.key||e.uuid(),g="INSERT INTO "+this.name+" (value, timestamp, id) VALUES (?,?,?)",h="UPDATE "+this.name+" SET value=?, timestamp=? WHERE id=?",i=function(){d&&(c.key=f,e.lambda(d).call(e,c))},j=[b(),f];return e.exists(c.key,function(b){e.db.transaction(function(d){var e=function(b){j.unshift(JSON.stringify(b)),d.executeSql(g,j,i,a)},f=function(b){delete b.key,j.unshift(JSON.stringify(b)),d.executeSql(h,j,i,a)};b?f(c):e(c)})}),this},batch:function(a,b){var c=[],d=!1,e=this,f=function(b){c.push(b),d=c.length===a.length},g=setInterval(function(){d&&(b&&e.lambda(b).call(e,c),clearInterval(g))},200);for(var h=0,i=a.length;h<i;h++)this.save(a[h],f);return this},get:function(b,c){var d=this,e="";this.isArray(b)?e="SELECT id, value FROM "+this.name+" WHERE id IN ('"+b.join("','")+"')":e="SELECT id, value FROM "+this.name+" WHERE id = '"+b+"'";var f=function(a,e){var f=null,g=[];if(e.rows.length)for(var h=0,i=e.rows.length;h<i;h++)f=JSON.parse(e.rows.item(h).value),f.key=e.rows.item(h).id,g.push(f);d.isArray(b)||(g=g.length?g[0]:null),c&&d.lambda(c).call(d,g)};return this.db.transaction(function(b){b.executeSql(e,[],f,a)}),this},exists:function(b,c){var d="SELECT * FROM "+this.name+" WHERE id = ?",e=this,f=function(a,b){c&&e.fn("exists",c).call(e,b.rows.length>0)};return this.db.transaction(function(c){c.executeSql(d,[b],f,a)}),this},all:function(b){var c=this,d="SELECT * FROM "+this.name,e=[],f=this.fn(this.name,b)||undefined,g=function(a,b){if(b.rows.length!=0)for(var d=0,g=b.rows.length;d<g;d++){var h=JSON.parse(b.rows.item(d).value);h.key=b.rows.item(d).id,e.push(h)}f&&f.call(c,e)};return this.db.transaction(function(b){b.executeSql(d,[],g,a)}),this},remove:function(b,c){var d=this,e=typeof b=="string"?b:b.key,f="DELETE FROM "+this.name+" WHERE id = ?",g=function(){c&&d.lambda(c).call(d)};return this.db.transaction(function(b){b.executeSql(f,[e],g,a)}),this},nuke:function(b){var c="DELETE FROM "+this.name,d=this,e=b?function(){d.lambda(b).call(d)}:function(){};return this.db.transaction(function(b){b.executeSql(c,[],e,a)}),this}}}()),window.LawnchairIEUserdata=Lawnchair.adapter("ie-userdata",{valid:function(){return typeof document.body.addBehavior!="undefined"},init:function(){var a=document.createElement("span");a.style.behavior="url('#default#userData')",a.style.position="absolute",a.style.left=1e4,document.body.appendChild(a),this.storage=a,this.storage.load("lawnchair")},get:function(a,b){var c=JSON.parse(this.storage.getAttribute(a)||"null");c&&(c.key=a),b&&b(c)},save:function(a,b){var c=a.key||"lc"+this.uuid();delete a.key,this.storage.setAttribute(c,JSON.stringify(a)),this.storage.save("lawnchair"),b&&(a.key=c,b(a))},all:function(a){var b=this.terseToVerboseCallback(a),c=this.storage.XMLDocument.firstChild.attributes,d=[],e,f;for(var g=0,h=c.length;g<h;g++)e=c[g],f=JSON.parse(e.nodeValue||"null"),f&&(f.key=e.nodeName,d.push(f));b&&b(d)},remove:function(a,b){var c=typeof a=="string"?a:a.key;this.storage.removeAttribute(c),this.storage.save("lawnchair"),b&&b()},nuke:function(a){var b=this;this.all(function(c){for(var d=0,e=c.length;d<e;d++)c[d].key&&b.remove(c[d].key);a&&a()})}}),Lawnchair.plugin({count:function(a,b){[].slice.call(arguments).length===1&&(b=a,a="key");var c=0;this.each(function(b){b[a]&&c++}),this.fn("count",b).call(this,c)},sum:function(a,b){var c=0;this.each(function(b){b[a]&&(c+=b[a])}),this.fn("sum",b).call(this,c)},avg:function(a,b){this.sum(a,function(c){this.count(a,function(a){this.fn("avg",b).call(this,c/a)})})},min:function(a,b){this._minOrMax("min",a,b)},max:function(a,b){this._minOrMax("max",a,b)},_minOrMax:function(a,b,c){var d,e;this.all(function(c){e=c.map(function(a){return a[b]}),d=Math[a].apply(Math,e)}),this.fn(a,c).call(this,d)}}),Lawnchair.plugin(function(){var a="save batch get remove nuke".split(" "),b={before:{},after:{}};for(var c=0,d=a.length;c<d;c++)b.before[a[c]]=[],b.after[a[c]]=[];return{init:function(){for(var b=0,c=a.length;b<c;b++)this.evented(a[b])},evented:function(a){var b=this[a],c=this;this[a]=function(){var d=[].slice.call(arguments),e=d[0],f=d[d.length-1],g=!1;this.fire("before",a,e),typeof f=="function"&&(d[d.length-1]=function(b){f.call(c,b),c.fire("after",a,b)},g=!0),b.apply(c,d),g||c.fire("after",a,e)}},fire:function(a,c,d){var e=b[a][c];for(var f=0,g=e.length;f<g;f++)e[f].call(this,d)},clearBefore:function(a){b.before[a]=[]},clearAfter:function(a){b.after[a]=[]},before:function(a,c){b.before[a].push(c)},after:function(a,c){b.after[a].push(c)}}}()),Lawnchair.plugin({page:function(a,b){var c=[],d=5,e=~~a||1,f=e+1,g=e-1,h=e==1?0:g*d,i=h>=d?h+d:d;this.all(function(a){c=a});var j=Math.ceil(c.length/d),a={max:j,next:f>j?j:f,prev:g==0?1:g};return this.__results=a[this.name]=c.slice(h,i),b&&this.fn("page",b).call(this,a),this}}),Lawnchair.plugin(function(){var a=function(a,b){var c=a.split("?").filter(function(a){return a!=""}),d="";for(var e=0,f=c.length;e<f;e++)d+=c[e]+b[e];return d},b=function(a){return function(b,c){return b[a]<c[a]?-1:b[a]>c[a]?1:0}};return{where:function(){var b=[].slice.call(arguments),c=b.shift(),d=b[b.length-1],e=c.match(/\?/g),f=e&&e.length>0?a(c,b.slice(0,e.length)):c,g=new Function(this.record,"return !!("+f+")"),h=[],i;return this.all(function(a){for(var b=0,c=a.length;b<c;b++)g(a[b])&&h.push(a[b])}),this.__results=h,b.length===1&&this.fn(this.name,d).call(this,this.__results),this},asc:function(a,c){return this.fn(this.name,c).call(this,this.__results.sort(b(a))),this},desc:function(a,c){return this.fn(this.name,c).call(this,this.__results.sort(b(a)).reverse()),this}}}());